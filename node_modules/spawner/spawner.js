var _ = global._
var Fs = require('fs')
var spawnerExitTemplate = _.template(Fs.readFileSync(__dirname+'/spawner_exit_template.html').toString())
var spawnerStartTemplate = _.template(Fs.readFileSync(__dirname+'/spawner_start_template.html').toString())
var spawnerErrorTemplate = _.template(Fs.readFileSync(__dirname+'/spawner_error_template.html').toString())

function spawn(command, args, options){
	var spawn = require('child_process').spawn
  if(!command){
    global.BABB.EventEmitter.trigger('error', spawnerErrorTemplate({error : 'no command specified'}))
    return
  }
	
  var cmdProcess = spawn(command, args, options)
  var killidProcess = spawn(
    global.BABB.TestConfig.killidPath, 
    [cmdProcess.pid]
  )
  console.log(command+' started')
  global.BABB.EventEmitter.trigger('status', spawnerStartTemplate({command: command, args : args, options : options}))
  
  cmdProcess.on('exit', function(code){
		console.log(command+' exited with code '+code)
    global.BABB.EventEmitter.trigger('info', spawnerExitTemplate({command: command, code: code}))
    if(!killidProcess.killed){
      killidProcess.kill()
    }
	})
  
}


exports.spawn = spawn