var fs = require('fs')
var path = require('path')

var stop = false

exports.find = function(start, searchedFilename, callback){
  stop = false  
  walk(start, function(e, dirPath, dirs, files){ 
    if(files && files.indexOf(searchedFilename) != -1){      
      stop = true
      callback(path.normalize(path.join(dirPath, searchedFilename)))
    }
  })
}

function walk(start, callback) {
  if(stop){
    return
  }
  
  fs.lstat(start, function (err, stat) {
    if (err) { return callback(err) }
    
    if (stat.isDirectory()) {
      fs.readdir(start, function (err, files) {
        var coll = files.reduce(function (acc, i) {
          var abspath = path.join(start, i)
          
          try{
            if (fs.statSync(abspath).isDirectory()) {
              walk(abspath, callback)
              acc.dirs.push(i)
            } else {
              acc.names.push(i)
            }
          }catch(err){
            console.log('error encountered while searching : '+err)
          }
          
          return acc
        }, {"names": [], "dirs": []})

        return callback(null, start, coll.dirs, coll.names)
      })      
    } else {
      return callback(new Error("path: " + start + " is not a directory"))
    }
    
  })
}
