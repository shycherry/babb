var $ = global.$
var Backbone = global.Backbone
var _ = global._

var Fs = require('fs')


exports.ItemsCollectionView = Backbone.View.extend({
   
  bindCoverflow : function(){
    var Coverflow = require('coverflow')
    var baseWidth = window.innerWidth/2
    var coverflowModel = new Coverflow.CoverflowModel({
      template : _.template(Fs.readFileSync('./platform-template.html').toString()),
      selectedIndex:1,
      height: window.innerHeight,      
      width : window.innerWidth,
      perspective : baseWidth,
      cellWidth : baseWidth,
      cellHeight : baseWidth,
      coverGap : baseWidth/4,
      coverOffset : baseWidth,
      zUnselected : -baseWidth,
      circularSelection : false,
    })

    this.coverflowView = new Coverflow.CoverflowView({
      el:'#coverflow',
      model : coverflowModel
    })
    
    var self = this

    this.coverflowView.render()
    global.coverflow = this.coverflowView    
  },
  
  doBindings : function(){
    this.bindCoverflow()
    _.bindAll(this, 'bindCoverflow')
    _.bindAll(this, 'render')
    _.bindAll(this, 'onSniffed')
    _.bindAll(this, 'onSelectedChange')
    _.bindAll(this, 'onSelected')
    
    $(window).resize(this.bindCoverflow)
    this.itemsToRender = []
    this.itemsCollection.bind('change', this.render)
    this.itemsCollection.bind('add', _.throttle(this.render,100))
    this.itemsCollection.bind('remove', this.render)
    this.itemsCollection.bind('reset', this.render)
    this.$el.on("click", function(event){
      event.stopPropagation()
    })    
  },
  
  onSelected : function(iItem){
  },
  
  getSelected: function(){
    return this.selectedItem
  },
  
  setSelected : function(iItem){    
    var changed = (this.selectedItem != iItem)
    if(changed){
      this.selectedItem = iItem
      this.onSelectedChange(iItem)      
      //this.render()
    }        
    this.onSelected(iItem)
  },
  
  selectNext : function(){
    this.coverflowView.Next()
    var next = null
    if(this.selectedItem == null){
      next = this.itemsCollection.first()
    }else{
      var indexSelected = this.itemsCollection.indexOf(this.selectedItem)
      next = this.itemsCollection.at( this.getNextIndex(indexSelected) )
    }
    if(next){
      this.setSelected(next)
    }    
  },

  selectPrevious : function(){
    this.coverflowView.Previous()
    var previous = null
    if(this.selectedItem == null){
      previous = this.itemsCollection.first()
    }else{
      var indexSelected = this.itemsCollection.indexOf(this.selectedItem)
      previous = this.itemsCollection.at( this.getPreviousIndex(indexSelected) )
    }
    if(previous){
      this.setSelected(previous)
    }    
  },
  
  getNextIndex : function(baseIndex){
    return (baseIndex + 1) % this.itemsCollection.size()
  },
  
  getPreviousIndex : function(baseIndex){
    return (baseIndex + this.itemsCollection.size() - 1) % this.itemsCollection.size() 
  },  
  
  validSelected : function(){
    this.trigger('selectionValidated', this.selectedItem)
  },

  back:function(){    
    this.trigger('back')
  },
  
  updateItemsToRender: function(){
    this.itemsToRender = []
    
    var indexSelected = this.itemsCollection.indexOf(this.selectedItem)
    if(indexSelected == -1){
      return
    }
    
    var startIndex = indexSelected    
    
    var locNbItemsToRender = Math.min(
      this.itemsCollection.size(), 
      global.BABB.GlobalConfig.maxItemsToRender
    )
    
    for(var i = 0; i < locNbItemsToRender; i++ ){
      var locItem = this.itemsCollection.at(startIndex)
      if(locItem){
        this.itemsToRender.push(locItem)
      }
      startIndex = this.getNextIndex(startIndex)
    }
  },
  
  render : function() {
    console.log('call to '+this.toString()+' render')
    this.updateItemsToRender()  
    var renderedContent = this.template({collection : this.itemsToRender})
    this.coverflowView.setCollection(this.itemsToRender)
    $(this.$el).html(renderedContent)
    
    return this
  }
})